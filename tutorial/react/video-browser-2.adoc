:toc:
:imagesdir: images

ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

== Divide application into components

We should spend some time to get our application properly divided into components. The goal is to get distinct and encapsulated code components that together becomes the complete video browser. How to decide on component architecture is of course an artform in itself, with many different ways to do it.

In our case it makes at least somewhat sense to divide the application as the red rectangles depict:

image::video-app-mockup-divided-to-components.png[mockup2,600]

The picture shows that we have a top most component (the largest rectangle) which holds a set of child components. We do already have this top component in place - `app.js`, or in JSX-lingo: `<App />`

Let's settle on these child components and names

[ditaa]
....
App
 |
 +-- SearchBar
 +-- VideoDetail
 +-- VideoList
        |
        +-- VideoListItem
....

[cols=2*,options=header]
|===
|Component
|Description

|App
|The aggregating top component

|SearchBar
|Component responsible for rendering the search bar and to keep track of input

|VideoDetail
|Contains code for displaying an embedded video player, together with title and description, of a user selected video.

|VideoList
|Shows a list of videos from search result

|VideoListItem
|A single video from search result. If user clicks this item, the video should be sent to VideoDetail component

|===

Given these components, let's create the files we need, one file per component.

[quote]
____
. Create a directory `my-app/src/components`
. Create `src/components/search-bar.js`
. Create `src/components/video-detail.js`
. Create `src/components/video-list.js`
. Create `src/components/video-list-item.js`
____

== SearchBar

The search bar component should render an input field, so start by adding a class based React component that returns a simple `<input/>`

[quote]
____
. In `search-bar.js`, create the search component
+
[source,javascript]
----
import React, {Component} from 'react';

class SearchBar extends Component {

    render() {
        return <input/>;
    }
}
----
____

We have created the component, but we also need to make visible for other components, so it could be imported.

[quote]
____
. Last in `search-bar.js`, add export statement
+
[source,javascript]
----
export default SearchBar;
----
____

Now let's flip back to `app.js` so we can import and use the <SearchBar/> component

[quote]
____
. In `sapp.js`, add export statement to SearchBar. Note that you must specify the relative path to the file, and ommit the ".js" prefix
+
[source,javascript]
----
import SearchBar from './components/search-bar';
----
+
. Replace the "Hello world" in return statment with the SearchBar tag instead
+
[source,javascript]
----
   render() {
       return <div>
           <SearchBar />
       </div>;
   }
----
+
Note the deliberate line break, it is an attempt to make it more readable and html-like. The indentation doesn't look good however, so a common best practice is to use proper parenthesis around the expression:
+
[source,javascript]
----
   render() {
       return (
           <div>
               <SearchBar/>
           </div>
       );
   }
----
____

Save the file and take look in the browser. What do you see?

=== Handle input events

You should now see a simple, unadorned, search bar in top left corner of the browser. Even though it is possible to enter text in the input, nothing more actually happens. We want to capture the content entered to use it as a search term.

To do this we should write a event handler function and pass it to the <input> onChange event.

[quote]
____
. In `search-bar.js`, add event handler function that logs search bar content to console on every key stroke
+
[source,javascript]
----
import React, {Component} from 'react';

class SearchBar extends Component {

    handleInputChange(event) {
        console.log(event.target.value);
    }

    render() {
        return <input/>;
    }
}

export default SearchBar;
----
+
. Pass event handler to element we want to monitor, more specifically it's `onChange` event
+
[source,javascript]
----
import React, {Component} from 'react';

class SearchBar extends Component {

    handleInputChange(event) {
        console.log(event.target.value);
    }

    render() {
        return <input onChange={this.handleInputChange}/>;
    }
}

export default SearchBar;
----
[NOTE]
Any input you make to search bar should now turn up in the console log

It is also possible to use the _condensed arrow function_ instead, this allows us to inline the function directly in the onChange event:

[source,javascript]
----
import React, {Component} from 'react';

class SearchBar extends Component {
    render() {
        return <input onChange={event => console.log(event.target.value)} />;
    }
}

export default SearchBar;
----
____

=== Constructor and state

To be able to keep track of the current state of the user input, we need to initialize the SearchBar component's `state object`. This is done in the `constructor` method of the class.

[quote]
____
. In `search-bar.js`, add a method named `constructor` where `this.state` is initialized holding an object with the current search term
+
[source,javascript]
----
class SearchBar extends Component {

    constructor(props) {
        super(props);

        this.state = {searchTerm: ''};
    }
    
    ...
    
}
----
____

Now we want to capture any changes to the input field's value into the property `searchTerm` of the state object. This will be done by changing the `onChange` attribute of the input element to call `this.setState()` instead of `console.log()`.

[quote]
____
. Change the onChange attribute
+
[source,javascript]
----
render() {
	return <input onChange={event => this.setState({searchTerm: event.target.value})} />;
}
----
+
. As a fun thing, print out `this.state.searchTerm` to the page just to see it change:
+
[source,javascript]
----
render() {
    return (
        <div>
            <input onChange={event => this.setState({searchTerm: event.target.value})} />
            <p>Value of the input: {this.state.searchTerm}</p>
        </div>
    );
}
----
+
[NOTE]
This highlights a key concept in React: _Whenever a component's state change, the component (and it's children) immediately re-renders_
+
. Revert back by removing the value output, but keep the div tags for later
+
[source,javascript]
----
render() {
    return (
        <div>
            <input onChange={event => this.setState({searchTerm: event.target.value})} />
        </div>
    );
}
----
____

* TODO: Add a section about constructor, state and setState() here

React has the concept of _Controlled component_, which an html form element that has it's value set by React state, and this value only ever changes when the state changes. This makes the React state be the “single source of truth”.

[quote]
____
. Make the search bar `<input/>` element a controlled component
+
[source,javascript]
----
render() {
    return (
        <div>
            <input
                value={this.state.searchTerm}
                onChange={event => this.setState({searchTerm: event.target.value})} />
        </div>
    );
}
----
+
When user enters text the `onChange` handler is called, triggering React to rerender. When rendering is complete, the `value` is set to `this.state.searchTerm`. This allows us to read the `value` of the input more easily since we can read `this.state.searchTerm` whenever we want and be sure that it will always have the latest input from user.
+
link:https://reactjs.org/docs/forms.html#controlled-components[React doc about Controlled components]
____

== Searching for videos

Now we are ready to do some serious YouTube video searches. But before going bonkers on that, we need to quickly set up some things.

[IMPORTANT]
If you haven't already done so, generate an Youtube API key as described in
<<prerequisites.adoc#generate-a-youtube-api-key,Prerequisites: Generate a youtube API key>>

[quote]
____
. Take your generated API key and add it to a constant in `app.js`
+
[source,javascript]
----
const API_KEY = "<the-key>";
----
+
. Install the google npm package that will helps us do searches
+
[source,bash]
----
# Make sure to execute from directory "my-app"
npm install --save youtube-api-search
----
+
This will install the package so we can import needed components to use for searching.
____

Now we are ready to go bonkers.

Central in React is the concept of downwards dataflow, which says _"Any state is always owned by some specific component, and any data or UI derived from that state can only affect components “below” them in the tree"_. 

[TIP]
link:https://reactjs.org/docs/state-and-lifecycle.html#the-data-flows-down[React doc about Data flows down]

This implies that the most parent component in an application should be responsible for fetching data.

In our case `app.js` is the top most component so we will let it handle the data fetching.

[quote]
____
. In `app.js`, add import to youtube searh utilities
+
[source,javascript]
----
import YTSearch from 'youtube-api-search';
----
. Just to demonstrate how `YTSearch` function works, let us do a quick and dirty call just to see what it does. Add a call to `YTSearch` as follows:
+
[source,javascript]
----
const API_KEY = "<the-key>";

YTSearch({key: API_KEY, term: 'acorntechnology'}, (data) => {
    console.log(data);
});

class App extends React.Component {
  ...
}
----
+
Now take a look in the developer's tool Console log. There you should see the search result, a list of videos looking something like this:
+
image:YTSearch-acorn-result.png[]
____

We want to update the the list of videos whenever the user searches for them, which sounds like a great use for state. When the user searches, we want to set that search result on state.

[quote]
____
. In `app.js`, add constructor and initialize the `state` with a property called `videos` holding and empty array
+
[source,javascript]
----
class App extends React.Component {
    
    constructor(props) {
        super(props);

        this.state = { videos: [] };
    }  
    
    ...
}
----
+
. move the `YTSearch` function inside the constructor and instead of using `console.log()` to log data, set the `data` (i.e. search result videos) to `state`
+
[source,javascript]
----
class App extends React.Component {
    
    constructor(props) {
        super(props);

        this.state = { videos: [] };

        YTSearch({key: API_KEY, term: 'acorntechnology'}, (data) => {
            this.setState({ videos: data });
        });
    }  
    
    ...
}
----
+
Or perhaps a better name for `data` here would be `videos`:
+
[source,javascript]
----
class App extends React.Component {
    
    constructor(props) {
        super(props);

        this.state = { videos: [] };

        YTSearch({key: API_KEY, term: 'acorntechnology'}, (videos) => {
            this.setState({ videos: videos });
        });
    } 
    
    ...
}
----
____

So now we have a `<App/>` component that upon initialization will perform a YouTube search on "acorntechnology" and store the result in `this.state.videos`.

This is good and we can leave the matter of searching for a while. Let's start focusing on the video list and it's items by start putting these components together.

== VideoList

The ultimate goal of the `VideoList` component is to display a list of one or more `VideoListItem`, based on search results produced by `App` and `SearchBar`.

This component will not need to hold any state, so we can make it a plain _functional component_.

[NOTE]
_Class based components_ versus _functional components_: Up until now we have used _class based components_. These types of components can, as you have seen, hold local state. A React _functional component_ is literally a plain javascript function, which can take 0 or more object arguments and returns a React element.

The `VideoList` will get the videos from search result and should then create visual elements based on the content. It will not need any local states for achieving this.

[quote]
____
. In `video-list.js`, create a const `VideoList` and assign it a plain function returning an empty `<ul>` element
+
[source,javascript]
----
import React from 'react';

const VideoList = function () {
    return (
        <ul className="col-md-4 list-group">

        </ul>
    );
};
----
+
This can also be written using the condensed fat arrow syntax:
+
[source,javascript]
----
import React from 'react';

const VideoList = () => {
    return (
        <ul className="col-md-4 list-group">

        </ul>
    );
};
----
+
. Make sure to export the component so we can import it in other components
+
[source,javascript]
----
export default VideoList;
----
+
. Also note that we did sneak in some styling in `<ul className="col-md-4 list-group">`. For convenience we will make use of some ready made CSS from Bootstrap. In order to this to work we must link to it, so in `my-app/public/index.html` please add the following `<link>` element:
+
[source,html]
----
<!DOCTYPE html>
<html lang="en">
<head>
    ...
    <link rel="stylesheet" href="https://cdn.rawgit.com/twbs/bootstrap/48938155eb24b4ccdde09426066869504c6dab3c/dist/css/bootstrap.min.css">
    ...
</head>
<body>
    ...
</body>
</html>
----
____

Ok, the `VideoList` component is now in place, returning an empty `<ul>` element. We should add more content to this element soon, but first we will head back to `app.js` and use the `VideoList` component there. 

The current content of `app.js` should now look similar to this:

[source,javascript]
----
import React from 'react';
import SearchBar from './components/search-bar';
import YTSearch from 'youtube-api-search';

const API_KEY = "<the-key>";

class App extends React.Component {

    constructor(props) {
        super(props);

        this.state = { videos: [] };

        YTSearch({key: API_KEY, term: 'acorntechnology'}, (videos) => {
            this.setState({ videos: videos });
        });
    }

    render() {
        return (
            <div>
                <SearchBar/>
            </div>
        );
    }
}

export default App;
----

The only thing displayed on page right now is the `<SearchBar/>` element. Let's add the `<VideoList/>` element as well. 

[quote]
____
. In `app.js`, add import to `VideoList`
+
[source,javascript]
----
import VideoList from "./components/video-list";
----
+
. Place `<VideoList/>` below `<SearchBar/>`
+
[source,javascript]
----
render() {
    return (
        <div>
            <SearchBar/>
            <VideoList/>
        </div>
    );
}
----
____

Not much happens in the browser yet. We need to do some additional steps to get a search result list rendered.

We are in a situation where the `<App/>` component's state holds the videos search result. To be able to show the results in `VideoList`, we must pass it down somehow. React supports this in a quite straight forward fashion, by allowing us to add properties to JSX tags. This usually referred to as _passing props_.

[quote]
____
. In `app.js`, add `videos` property to the VideoList JSX tag, pass `this.state.videos` as props.
+
[source,javascript]
----
render() {
    return (
        <div>
            <SearchBar/>
            <VideoList videos={this.state.videos}/>
        </div>
    );
}
----
+
. In `video-list.js`, add argument `props` to the function. This will be the recieving end of the props passing. Also add a temporary printout of the props content inside the `<ul>` element.
+
[source,javascript]
----
import React from 'react';

const VideoList = (props) => {
    return (
        <ul className="col-md-4 list-group">
            {props.videos.length}
        </ul>
    );
};

export default VideoList;
----
+
Take peek at the browser, you should see the length of search result array below the search bar.
____
